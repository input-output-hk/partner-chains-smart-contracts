SHELL := bash
.SHELLFLAGS := -eu -o pipefail -c
.PHONY: source-build dev build test check-format update-scripts format spago2nix clean

BROWSER_RUNTIME ?= 1

spago-args := --purs-args="--censor-lib --stash --strict --censor-codes=UserDefinedWarning"
ps-sources := $(shell fd -epurs)
js-sources := $(shell fd -ejs)
dhall-sources := $(shell fd -edhall)
trustless-sidechain-serialise=cabal run trustless-sidechain-serialise --
onchain-dir := ../onchain/
haskell-scripts := $(wildcard $(onchain-dir)/src/TrustlessSidechain/*.hs) $(wildcard $(onchain-dir)/app/serialise/*.hs)

raw-scripts-purs := src/TrustlessSidechain/RawScripts.purs

ps-entrypoint := Main
ps-test-entrypoint := Test.Main

source-build:
	spago build ${spago-args}

dev: output.js
	@BROWSER_RUNTIME=${BROWSER_RUNTIME} webpack-dev-server --progress

build: output.js
	@BROWSER_RUNTIME=${BROWSER_RUNTIME} webpack --mode=production

test: src/TrustlessSidechain/RawScripts.purs
	@spago test ${spago-args} -m ${ps-test-entrypoint}

check-format:
	@purs-tidy check ${ps-sources}
	@eslint ${js-sources}
	@dhall lint --check ${dhall-sources}

format:
	@purs-tidy format-in-place ${ps-sources}
	@eslint --fix ${js-sources}
	@dhall lint ${dhall-sources}

spago2nix:
	@spago2nix generate
	@nixpkgs-fmt spago-packages.nix

update-scripts: ${raw-scripts-purs}

output.js: src/Main.purs ${raw-scripts-purs}
	@spago ${spago-args} bundle-module -m ${ps-entrypoint} -t $@

main.js: src/Main.purs $(raw-scripts-purs)
	@spago ${spago-args} bundle-app -m ${ps-entrypoint} -t $@

# RawScripts.purs is an autogenerated file that collects all the plutus scripts
# and allows our ctl code to reference them without relying on directory
# structure
${raw-scripts-purs}: ${haskell-scripts}
	@echo 'Generating `$@` with the following command...'
	cd $(onchain-dir) && ${trustless-sidechain-serialise} --purescript-plutus-scripts=${CURDIR}/${raw-scripts-purs}
	@echo 'Updated `$@`.'

clean:
	-rm src/TrustlessSidechain/RawScripts.purs
